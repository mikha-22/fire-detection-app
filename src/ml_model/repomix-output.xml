This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
config.json
Dockerfile.debug
fully_offline.py
incidents.jsonl
predictor.py
register_vertex_model.py
requirements.txt
temp_request.json
test_fully_offline.py
test_logic_offline.py
test_with_gcs.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="config.json">
{
    "criteria": [
        {
            "name": "Fire Intensity (Avg FRP)",
            "data_key": "avg_frp",
            "weight": 0.30,
            "type": "numerical_threshold",
            "direction": "ascending",
            "mapping": {
                "100": 2.0, "500": 5.0, "1000": 8.0, "1500": 10.0
            }
        },
        {
            "name": "Hotspot Density",
            "data_key": "point_count",
            "weight": 0.25,
            "type": "numerical_threshold",
            "direction": "ascending",
            "mapping": {
                "5": 2.0, "10": 4.0, "20": 7.0, "30": 10.0
            }
        },
        {
            "name": "Air Quality Impact",
            "data_key": "realtime_context.air_quality.air_quality_severity",
            "weight": 0.20,
            "type": "categorical",
            "mapping": {
                "low": 1.0, "moderate": 4.0, "high": 7.0, "severe": 10.0, "unknown": 3.0
            }
        },
        {
            "name": "Precipitation (Rain)",
            "data_key": "realtime_context.weather.precipitation_mm",
            "weight": 0.15,
            "type": "numerical_threshold",
            "direction": "ascending",
            "mapping": {
                "0": 10.0, "0.1": 1.0
            }
        },
        {
            "name": "Relative Humidity",
            "data_key": "realtime_context.weather.relative_humidity_percent",
            "weight": 0.05,
            "type": "numerical_threshold",
            "direction": "descending",
            "mapping": {
                "30": 10.0, "45": 8.0, "60": 5.0, "80": 3.0, "100": 1.0
            }
        },
        {
            "name": "Wind Speed",
            "data_key": "realtime_context.weather.wind_speed_kmh",
            "weight": 0.05,
            "type": "numerical_threshold",
            "direction": "ascending",
            "mapping": {
                "10": 1.0, "20": 3.0, "35": 7.0, "50": 10.0
            }
        }
    ]
}
</file>

<file path="Dockerfile.debug">
# Use a standard Python base image that matches the cloud environment
FROM python:3.11-slim

# Set a working directory inside the container
WORKDIR /app

# Copy and install requirements first. This is where many errors happen.
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the model's code into the container
COPY . .

# A placeholder command to indicate the build can finish
CMD ["echo", "Build successful"]
</file>

<file path="fully_offline.py">
import json
from google.cloud.aiplatform.prediction import LocalModel
from predictor import WildfireHeuristicPredictor

print("--- Building local model for OFFLINE container testing ---")

# 1. Build the local model object. This inspects your code and prepares it.
#    We use a 'local-test' tag to avoid confusion with the real deployed image.
local_model = LocalModel.build_cpr_model(
    ".",
    "asia-southeast2-docker.pkg.dev/haryo-kebakaran/wildfire-detector-repo/wildfire-heuristic-predictor:local-test",
    predictor=WildfireHeuristicPredictor,
    requirements_path="requirements.txt"
)

print("\n--- Deploying to local Docker endpoint. This may take a moment... ---")

# 2. This 'with' block starts the Docker container, runs the test, and automatically cleans up.
with local_model.deploy_to_local_endpoint(
    # The container needs access to the data file you downloaded.
    # We mount the current directory into the container's /data directory.
    host_port=8080, # Expose the container's port to your machine's port 8080
) as local_endpoint:
    
    print("Endpoint is live on local Docker. Sending prediction request...")

    # 3. Send the local data file to the local container for prediction.
    try:
        predict_response = local_endpoint.predict(
            request_file="incidents.jsonl",  # The file we downloaded in Step 1
            headers={"Content-Type": "application/json"},
        )

        print("\n--- ✅ Prediction Successful ---")
        print("\n--- Parsed Predictions ---")
        
        # Decode the raw byte content of the response
        response_content = predict_response.content.decode('utf-8')
        
        # The result is a single JSON object with a 'predictions' key
        all_predictions = json.loads(response_content)['predictions']
        
        for prediction in all_predictions:
            instance_id = prediction['instance_id']
            score = prediction['confidence_score']
            print(f"  Cluster ID: {instance_id}, Predicted Risk Score: {score:.4f}")

    except Exception as e:
        print(f"\n--- ❌ Prediction Failed ---")
        print(f"Error: {e}")
        print("\n--- Printing container logs for debugging ---")
        local_endpoint.print_container_logs()


print("\n--- Local endpoint has been shut down. Test complete. ---")
</file>

<file path="incidents.jsonl">
{
  "cluster_id": "fire_cluster_20190921_0",
  "point_count": 34,
  "centroid_latitude": -1.504118,
  "centroid_longitude": 103.992353,
  "detected_by": [
    "JAXA"
  ],
  "first_detected_utc": "2019-09-21T00:00:00+00:00",
  "last_detected_utc": "2019-09-21T00:00:00+00:00",
  "realtime_context": {
    "weather": {
      "timestamp_utc": "2019-09-21T00:00:00+00:00",
      "temperature_celsius": 24.39,
      "relative_humidity_percent": 86.76,
      "dew_point_celsius": 22.04,
      "precipitation_mm": 0.0,
      "wind_speed_kmh": 7.9,
      "wind_direction_deg": 155.77,
      "wind_gusts_kmh": 18.72
    },
    "air_quality": {
      "measurements": {
        "CO": {
          "status": "success",
          "value": 166040.8,
          "unit": "\u00b5mol/m\u00b2"
        },
        "AEROSOL": {
          "status": "success",
          "value": 1.47,
          "unit": "index"
        },
        "NO2": {
          "status": "success",
          "value": 20.22,
          "unit": "\u00b5mol/m\u00b2"
        }
      },
      "fire_indicators": [
        {
          "product": "CO",
          "severity": "severe",
          "value": 166040.79561653957,
          "message": "Carbon Monoxide severely elevated"
        },
        {
          "product": "AEROSOL",
          "severity": "moderate",
          "value": 1.4739731229153312,
          "message": "Aerosol Index moderately elevated"
        },
        {
          "product": "NO2",
          "severity": "moderate",
          "value": 20.2233971008969,
          "message": "Nitrogen Dioxide moderately elevated"
        }
      ],
      "air_quality_severity": "severe"
    }
  },
  "fire_severity_assessment": {
    "overall_severity": "severe",
    "severity_score": 6,
    "contributing_factors": [
      "High hotspot density (>=15)",
      "Severe air quality impact"
    ],
    "details": {
      "hotspot_count": 34,
      "weather_severity": "low",
      "air_quality_severity": "severe"
    }
  },
  "hotspots": [
    {
      "id": "5788",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.44,
        "longitude": 103.98,
        "frp_mean": 454.39,
        "frp_max": 2515.91,
        "n_detections": 74,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.44
        ]
      }
    },
    {
      "id": "5789",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.44,
        "longitude": 104.0,
        "frp_mean": 923.1,
        "frp_max": 3284.61,
        "n_detections": 76,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.44
        ]
      }
    },
    {
      "id": "5797",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.46,
        "longitude": 103.96,
        "frp_mean": 70.59,
        "frp_max": 70.59,
        "n_detections": 1,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1228,
        "objectid_1": 1229,
        "objectid": 1710,
        "layer_revi": "gambut",
        "shape_leng": 108377.618572,
        "globalid": "{02705CDB-9D82-49E9-9FB1-71BF19FD36D8}",
        "shape_Le_1": 109845.12218438149,
        "shape_Area": 383248267.1785685,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.96,
          -1.46
        ]
      }
    },
    {
      "id": "5798",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.46,
        "longitude": 103.98,
        "frp_mean": 809.36,
        "frp_max": 2761.41,
        "n_detections": 71,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.46
        ]
      }
    },
    {
      "id": "5799",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.46,
        "longitude": 104.0,
        "frp_mean": 1568.65,
        "frp_max": 3539.6,
        "n_detections": 81,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.46
        ]
      }
    },
    {
      "id": "5800",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.46,
        "longitude": 104.02,
        "frp_mean": 1196.42,
        "frp_max": 3677.01,
        "n_detections": 77,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.02,
          -1.46
        ]
      }
    },
    {
      "id": "5801",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.46,
        "longitude": 104.04,
        "frp_mean": 1195.97,
        "frp_max": 3676.86,
        "n_detections": 77,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.04,
          -1.46
        ]
      }
    },
    {
      "id": "5812",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.48,
        "longitude": 103.94,
        "frp_mean": 11.58,
        "frp_max": 12.13,
        "n_detections": 2,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1228,
        "objectid_1": 1229,
        "objectid": 1710,
        "layer_revi": "gambut",
        "shape_leng": 108377.618572,
        "globalid": "{02705CDB-9D82-49E9-9FB1-71BF19FD36D8}",
        "shape_Le_1": 109845.12218438149,
        "shape_Area": 383248267.1785685,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.94,
          -1.48
        ]
      }
    },
    {
      "id": "5813",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.48,
        "longitude": 103.96,
        "frp_mean": 42.09,
        "frp_max": 78.85,
        "n_detections": 3,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.96,
          -1.48
        ]
      }
    },
    {
      "id": "5814",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.48,
        "longitude": 103.98,
        "frp_mean": 359.9,
        "frp_max": 1196.17,
        "n_detections": 42,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.48
        ]
      }
    },
    {
      "id": "5815",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.48,
        "longitude": 104.0,
        "frp_mean": 801.45,
        "frp_max": 2454.11,
        "n_detections": 75,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.48
        ]
      }
    },
    {
      "id": "5816",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.48,
        "longitude": 104.02,
        "frp_mean": 704.74,
        "frp_max": 2242.5,
        "n_detections": 85,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.02,
          -1.48
        ]
      }
    },
    {
      "id": "5817",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.48,
        "longitude": 104.04,
        "frp_mean": 704.56,
        "frp_max": 2242.4,
        "n_detections": 85,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.04,
          -1.48
        ]
      }
    },
    {
      "id": "5831",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.5,
        "longitude": 103.94,
        "frp_mean": 10.4,
        "frp_max": 10.4,
        "n_detections": 1,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.94,
          -1.5
        ]
      }
    },
    {
      "id": "5832",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.5,
        "longitude": 103.96,
        "frp_mean": 20.99,
        "frp_max": 20.99,
        "n_detections": 1,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.96,
          -1.5
        ]
      }
    },
    {
      "id": "5833",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.5,
        "longitude": 103.98,
        "frp_mean": 63.94,
        "frp_max": 187.7,
        "n_detections": 8,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.5
        ]
      }
    },
    {
      "id": "5834",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.5,
        "longitude": 104.0,
        "frp_mean": 114.81,
        "frp_max": 498.42,
        "n_detections": 49,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.5
        ]
      }
    },
    {
      "id": "5835",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.5,
        "longitude": 104.02,
        "frp_mean": 258.96,
        "frp_max": 897.88,
        "n_detections": 42,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.02,
          -1.5
        ]
      }
    },
    {
      "id": "5836",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.5,
        "longitude": 104.04,
        "frp_mean": 258.92,
        "frp_max": 897.88,
        "n_detections": 42,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.04,
          -1.5
        ]
      }
    },
    {
      "id": "5844",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.52,
        "longitude": 103.94,
        "frp_mean": 18.57,
        "frp_max": 23.07,
        "n_detections": 5,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.94,
          -1.52
        ]
      }
    },
    {
      "id": "5845",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.52,
        "longitude": 103.98,
        "frp_mean": 31.75,
        "frp_max": 54.0,
        "n_detections": 7,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.52
        ]
      }
    },
    {
      "id": "5846",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.52,
        "longitude": 104.0,
        "frp_mean": 70.2,
        "frp_max": 326.7,
        "n_detections": 37,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.52
        ]
      }
    },
    {
      "id": "5847",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.52,
        "longitude": 104.02,
        "frp_mean": 97.44,
        "frp_max": 230.03,
        "n_detections": 61,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.02,
          -1.52
        ]
      }
    },
    {
      "id": "5848",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.52,
        "longitude": 104.04,
        "frp_mean": 97.43,
        "frp_max": 229.48,
        "n_detections": 61,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.04,
          -1.52
        ]
      }
    },
    {
      "id": "5857",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.54,
        "longitude": 103.94,
        "frp_mean": 171.73,
        "frp_max": 760.91,
        "n_detections": 13,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.94,
          -1.54
        ]
      }
    },
    {
      "id": "5858",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.54,
        "longitude": 103.96,
        "frp_mean": 171.73,
        "frp_max": 760.86,
        "n_detections": 13,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.96,
          -1.54
        ]
      }
    },
    {
      "id": "5859",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.54,
        "longitude": 103.98,
        "frp_mean": 147.25,
        "frp_max": 479.31,
        "n_detections": 4,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.54
        ]
      }
    },
    {
      "id": "5860",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.54,
        "longitude": 104.0,
        "frp_mean": 41.78,
        "frp_max": 41.78,
        "n_detections": 1,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.54
        ]
      }
    },
    {
      "id": "5861",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.54,
        "longitude": 104.02,
        "frp_mean": 58.66,
        "frp_max": 140.58,
        "n_detections": 39,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.02,
          -1.54
        ]
      }
    },
    {
      "id": "5862",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.54,
        "longitude": 104.04,
        "frp_mean": 56.93,
        "frp_max": 140.58,
        "n_detections": 41,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.04,
          -1.54
        ]
      }
    },
    {
      "id": "5874",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.56,
        "longitude": 103.96,
        "frp_mean": 1210.24,
        "frp_max": 2821.0,
        "n_detections": 57,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.96,
          -1.56
        ]
      }
    },
    {
      "id": "5875",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.56,
        "longitude": 103.98,
        "frp_mean": 802.65,
        "frp_max": 2160.18,
        "n_detections": 5,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          103.98,
          -1.56
        ]
      }
    },
    {
      "id": "5876",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.56,
        "longitude": 104.0,
        "frp_mean": 70.89,
        "frp_max": 187.46,
        "n_detections": 53,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.0,
          -1.56
        ]
      }
    },
    {
      "id": "5877",
      "type": "Feature",
      "properties": {
        "year": 2019,
        "month": 9,
        "day": 21,
        "latitude": -1.56,
        "longitude": 104.02,
        "frp_mean": 63.5,
        "frp_max": 110.58,
        "n_detections": 25,
        "acq_datetime": "2019-09-21 00:00:00+00:00",
        "source": "JAXA",
        "index_right": 1265,
        "objectid_1": 1266,
        "objectid": 1747,
        "layer_revi": "gambut",
        "shape_leng": 429079.260415,
        "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}",
        "shape_Le_1": 427203.8494205073,
        "shape_Area": 2683153680.2708316,
        "cluster_id": 0
      },
      "geometry": {
        "type": "Point",
        "coordinates": [
          104.02,
          -1.56
        ]
      }
    }
  ]
}
</file>

<file path="predictor.py">
import os
import json
import numpy as np
from typing import Any, Dict, List

from google.cloud.aiplatform.prediction.predictor import Predictor

# --- Heuristic Model Logic (This class remains correct) ---
class FireRiskHeuristicModel:
    def __init__(self, config: Dict[str, Any]):
        if 'criteria' not in config or not isinstance(config['criteria'], list):
            raise ValueError("Configuration must contain a 'criteria' list.")
        self.criteria: List[Dict[str, Any]] = config['criteria']
        self._validate_config()

    def _validate_config(self):
        total_weight = sum(c['weight'] for c in self.criteria)
        if not np.isclose(total_weight, 1.0):
            raise ValueError(f"Sum of all weights must be 1.0, but is {total_weight}")

    def _sigmoid(self, x: float) -> float:
        return 1 / (1 + np.exp(-x))

    def _get_value_from_dot_key(self, data: Dict[str, Any], key: str) -> Any:
        keys = key.split('.')
        value = data
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else: return None
        return value

    def _get_criterion_score(self, criterion: Dict[str, Any], data: Dict[str, Any]) -> float:
        data_key = criterion['data_key']
        value = self._get_value_from_dot_key(data, data_key)

        if value is None: return 5.0

        if criterion['type'] == 'categorical':
            return float(criterion['mapping'].get(str(value).lower(), 5.0))
        
        elif criterion['type'] == 'numerical_threshold':
            direction = criterion.get("direction", "ascending")
            sorted_thresholds = sorted(criterion['mapping'].items(), key=lambda item: float(item[0]))
            for threshold, score in sorted_thresholds:
                if float(value) <= float(threshold): return float(score)
            if direction == "ascending": return float(max(criterion['mapping'].values()))
            else: return float(min(criterion['mapping'].values()))
        else:
            raise ValueError(f"Unsupported criterion type: {criterion['type']}")

    def _calculate_raw_score(self, data: Dict[str, Any]) -> float:
        total_raw_score = sum(self._get_criterion_score(c, data) * c['weight'] for c in self.criteria)
        return total_raw_score - 5.0

    def predict_confidence(self, data: Dict[str, Any]) -> Dict[str, Any]:
        raw_score = self._calculate_raw_score(data)
        confidence_score = self._sigmoid(raw_score)
        return {"confidence_score": confidence_score, "raw_score": raw_score}


# --- CPR Predictor Class ---
class WildfireHeuristicPredictor(Predictor):
    def __init__(self):
        self._model = None

    def load(self, artifacts_uri: str) -> None:
        config_path = os.path.join(artifacts_uri, "config.json")
        if not os.path.exists(config_path):
             config_path = "config.json"
        with open(config_path, 'r') as f:
            model_config = json.load(f)
        self._model = FireRiskHeuristicModel(config=model_config)

    # --- THIS IS THE CORRECTED PREPROCESS METHOD ---
    def preprocess(self, prediction_input: Dict[str, Any]) -> List[Dict[str, Any]]:
        """
        Pre-processes the input by calculating derived values needed by the model.
        This is where all data preparation logic should live.
        """
        processed_instances = []
        for instance in prediction_input["instances"]:
            # Calculate the average Fire Radiative Power (FRP)
            hotspots = instance.get("hotspots", [])
            if hotspots:
                frp_values = [h['properties']['frp_mean'] for h in hotspots if 'frp_mean' in h.get('properties', {})]
                avg_frp = np.mean(frp_values) if frp_values else 0
            else:
                avg_frp = 0
            
            # Add the newly calculated value to the instance for the model to use
            instance['avg_frp'] = avg_frp
            processed_instances.append(instance)
            
        return processed_instances
    # --- END OF CORRECTION ---

    def predict(self, instances: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        predictions = []
        for instance in instances:
            cluster_id = instance.get("cluster_id", "unknown_instance")
            result = self._model.predict_confidence(instance)
            result["instance_id"] = cluster_id
            predictions.append(result)
        return predictions

    def postprocess(self, prediction_results: List[Dict[str, Any]]) -> Dict[str, List[Dict[str, Any]]]:
        return {"predictions": prediction_results}
</file>

<file path="register_vertex_model.py">
# src/ml_model/register_vertex_model.py
import os
from google.cloud import aiplatform
# --- ADDED: Import the storage library ---
from google.cloud import storage
from google.cloud.aiplatform.prediction import LocalModel

from predictor import WildfireHeuristicPredictor

# --- Configuration (remains the same) ---
PROJECT_ID = "haryo-kebakaran"
REGION = "asia-southeast2"
DOCKER_REPO_NAME = "wildfire-detector-repo"
IMAGE_NAME = "wildfire-heuristic-predictor"
IMAGE_URI = f"{REGION}-docker.pkg.dev/{PROJECT_ID}/{DOCKER_REPO_NAME}/{IMAGE_NAME}:latest"

GCS_ARTIFACT_DIRECTORY_NAME = "models/wildfire_heuristic_predictor_v1/"
GCS_BUCKET_NAME = os.environ.get('GCS_BUCKET_NAME', 'fire-app-bucket')
GCS_ARTIFACT_URI = f"gs://{GCS_BUCKET_NAME}/{GCS_ARTIFACT_DIRECTORY_NAME}"

MODEL_DISPLAY_NAME = "wildfire-heuristic-predictor-model"

def main():
    print("--- Starting HEURISTIC model registration process ---")

    # ... (verification and build steps are the same)
    print("Verifying 'config.json' exists for the build context...")
    local_config_path = os.path.join(os.path.dirname(__file__), "config.json")
    if not os.path.exists(local_config_path):
        print(f"CRITICAL: 'config.json' not found at {local_config_path}. Cannot build predictor.")
        return
    print("'config.json' found.")

    print(f"--- Building Custom Prediction Routine container ---")
    local_model = LocalModel.build_cpr_model(
        ".",
        IMAGE_URI,
        predictor=WildfireHeuristicPredictor,
        requirements_path="requirements.txt"
    )
    local_model.get_serving_container_spec()

    print("\n--- Pushing container image to Artifact Registry ---")
    local_model.push_image()
    print("--- Image pushed successfully ---")

    # --- NEW STEP: Manually upload the config.json artifact before registering the model ---
    print("\n--- Manually uploading artifacts to GCS ---")
    storage_client = storage.Client()
    bucket = storage_client.bucket(GCS_BUCKET_NAME)
    destination_blob_name = os.path.join(GCS_ARTIFACT_DIRECTORY_NAME, "config.json")
    blob = bucket.blob(destination_blob_name)
    blob.upload_from_filename(local_config_path)
    print(f"Successfully uploaded {local_config_path} to gs://{GCS_BUCKET_NAME}/{destination_blob_name}")
    # ------------------------------------------------------------------------------------

    print("\n--- Uploading model to Vertex AI Model Registry ---")
    aiplatform.init(project=PROJECT_ID, location=REGION)
    
    model = aiplatform.Model.upload(
        local_model=local_model,
        display_name=MODEL_DISPLAY_NAME,
        artifact_uri=GCS_ARTIFACT_URI,
    )

    print(f"\nModel registration for '{MODEL_DISPLAY_NAME}' submitted successfully.")
    print(f"Resource name: {model.resource_name}")
    
    console_url = (
        f"https://console.cloud.google.com/vertex-ai/locations/{REGION}/models/"
        f"{model.name}?project={PROJECT_ID}"
    )
    print(f"View in console: {console_url}")

if __name__ == "__main__":
    main()
</file>

<file path="requirements.txt">
# src/ml_model/requirements.txt
google-cloud-storage
numpy
</file>

<file path="temp_request.json">
{"instances": [{"cluster_id": "fire_cluster_20190921_0", "point_count": 34, "centroid_latitude": -1.504118, "centroid_longitude": 103.992353, "detected_by": ["JAXA"], "first_detected_utc": "2019-09-21T00:00:00+00:00", "last_detected_utc": "2019-09-21T00:00:00+00:00", "realtime_context": {"weather": {"timestamp_utc": "2019-09-21T00:00:00+00:00", "temperature_celsius": 24.39, "relative_humidity_percent": 86.76, "dew_point_celsius": 22.04, "precipitation_mm": 0.0, "wind_speed_kmh": 7.9, "wind_direction_deg": 155.77, "wind_gusts_kmh": 18.72}, "air_quality": {"measurements": {"CO": {"status": "success", "value": 166040.8, "unit": "\u00b5mol/m\u00b2"}, "AEROSOL": {"status": "success", "value": 1.47, "unit": "index"}, "NO2": {"status": "success", "value": 20.22, "unit": "\u00b5mol/m\u00b2"}}, "fire_indicators": [{"product": "CO", "severity": "severe", "value": 166040.79561653957, "message": "Carbon Monoxide severely elevated"}, {"product": "AEROSOL", "severity": "moderate", "value": 1.4739731229153312, "message": "Aerosol Index moderately elevated"}, {"product": "NO2", "severity": "moderate", "value": 20.2233971008969, "message": "Nitrogen Dioxide moderately elevated"}], "air_quality_severity": "severe"}}, "fire_severity_assessment": {"overall_severity": "severe", "severity_score": 6, "contributing_factors": ["High hotspot density (>=15)", "Severe air quality impact"], "details": {"hotspot_count": 34, "weather_severity": "low", "air_quality_severity": "severe"}}, "hotspots": [{"id": "5788", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.44, "longitude": 103.98, "frp_mean": 454.39, "frp_max": 2515.91, "n_detections": 74, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.44]}}, {"id": "5789", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.44, "longitude": 104.0, "frp_mean": 923.1, "frp_max": 3284.61, "n_detections": 76, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.44]}}, {"id": "5797", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.46, "longitude": 103.96, "frp_mean": 70.59, "frp_max": 70.59, "n_detections": 1, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1228, "objectid_1": 1229, "objectid": 1710, "layer_revi": "gambut", "shape_leng": 108377.618572, "globalid": "{02705CDB-9D82-49E9-9FB1-71BF19FD36D8}", "shape_Le_1": 109845.12218438149, "shape_Area": 383248267.1785685, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.96, -1.46]}}, {"id": "5798", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.46, "longitude": 103.98, "frp_mean": 809.36, "frp_max": 2761.41, "n_detections": 71, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.46]}}, {"id": "5799", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.46, "longitude": 104.0, "frp_mean": 1568.65, "frp_max": 3539.6, "n_detections": 81, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.46]}}, {"id": "5800", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.46, "longitude": 104.02, "frp_mean": 1196.42, "frp_max": 3677.01, "n_detections": 77, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.02, -1.46]}}, {"id": "5801", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.46, "longitude": 104.04, "frp_mean": 1195.97, "frp_max": 3676.86, "n_detections": 77, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.04, -1.46]}}, {"id": "5812", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.48, "longitude": 103.94, "frp_mean": 11.58, "frp_max": 12.13, "n_detections": 2, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1228, "objectid_1": 1229, "objectid": 1710, "layer_revi": "gambut", "shape_leng": 108377.618572, "globalid": "{02705CDB-9D82-49E9-9FB1-71BF19FD36D8}", "shape_Le_1": 109845.12218438149, "shape_Area": 383248267.1785685, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.94, -1.48]}}, {"id": "5813", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.48, "longitude": 103.96, "frp_mean": 42.09, "frp_max": 78.85, "n_detections": 3, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.96, -1.48]}}, {"id": "5814", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.48, "longitude": 103.98, "frp_mean": 359.9, "frp_max": 1196.17, "n_detections": 42, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.48]}}, {"id": "5815", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.48, "longitude": 104.0, "frp_mean": 801.45, "frp_max": 2454.11, "n_detections": 75, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.48]}}, {"id": "5816", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.48, "longitude": 104.02, "frp_mean": 704.74, "frp_max": 2242.5, "n_detections": 85, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.02, -1.48]}}, {"id": "5817", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.48, "longitude": 104.04, "frp_mean": 704.56, "frp_max": 2242.4, "n_detections": 85, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.04, -1.48]}}, {"id": "5831", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.5, "longitude": 103.94, "frp_mean": 10.4, "frp_max": 10.4, "n_detections": 1, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.94, -1.5]}}, {"id": "5832", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.5, "longitude": 103.96, "frp_mean": 20.99, "frp_max": 20.99, "n_detections": 1, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.96, -1.5]}}, {"id": "5833", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.5, "longitude": 103.98, "frp_mean": 63.94, "frp_max": 187.7, "n_detections": 8, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.5]}}, {"id": "5834", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.5, "longitude": 104.0, "frp_mean": 114.81, "frp_max": 498.42, "n_detections": 49, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.5]}}, {"id": "5835", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.5, "longitude": 104.02, "frp_mean": 258.96, "frp_max": 897.88, "n_detections": 42, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.02, -1.5]}}, {"id": "5836", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.5, "longitude": 104.04, "frp_mean": 258.92, "frp_max": 897.88, "n_detections": 42, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.04, -1.5]}}, {"id": "5844", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.52, "longitude": 103.94, "frp_mean": 18.57, "frp_max": 23.07, "n_detections": 5, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.94, -1.52]}}, {"id": "5845", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.52, "longitude": 103.98, "frp_mean": 31.75, "frp_max": 54.0, "n_detections": 7, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.52]}}, {"id": "5846", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.52, "longitude": 104.0, "frp_mean": 70.2, "frp_max": 326.7, "n_detections": 37, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.52]}}, {"id": "5847", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.52, "longitude": 104.02, "frp_mean": 97.44, "frp_max": 230.03, "n_detections": 61, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.02, -1.52]}}, {"id": "5848", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.52, "longitude": 104.04, "frp_mean": 97.43, "frp_max": 229.48, "n_detections": 61, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.04, -1.52]}}, {"id": "5857", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.54, "longitude": 103.94, "frp_mean": 171.73, "frp_max": 760.91, "n_detections": 13, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.94, -1.54]}}, {"id": "5858", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.54, "longitude": 103.96, "frp_mean": 171.73, "frp_max": 760.86, "n_detections": 13, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.96, -1.54]}}, {"id": "5859", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.54, "longitude": 103.98, "frp_mean": 147.25, "frp_max": 479.31, "n_detections": 4, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.54]}}, {"id": "5860", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.54, "longitude": 104.0, "frp_mean": 41.78, "frp_max": 41.78, "n_detections": 1, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.54]}}, {"id": "5861", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.54, "longitude": 104.02, "frp_mean": 58.66, "frp_max": 140.58, "n_detections": 39, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.02, -1.54]}}, {"id": "5862", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.54, "longitude": 104.04, "frp_mean": 56.93, "frp_max": 140.58, "n_detections": 41, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.04, -1.54]}}, {"id": "5874", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.56, "longitude": 103.96, "frp_mean": 1210.24, "frp_max": 2821.0, "n_detections": 57, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.96, -1.56]}}, {"id": "5875", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.56, "longitude": 103.98, "frp_mean": 802.65, "frp_max": 2160.18, "n_detections": 5, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [103.98, -1.56]}}, {"id": "5876", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.56, "longitude": 104.0, "frp_mean": 70.89, "frp_max": 187.46, "n_detections": 53, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.0, -1.56]}}, {"id": "5877", "type": "Feature", "properties": {"year": 2019, "month": 9, "day": 21, "latitude": -1.56, "longitude": 104.02, "frp_mean": 63.5, "frp_max": 110.58, "n_detections": 25, "acq_datetime": "2019-09-21 00:00:00+00:00", "source": "JAXA", "index_right": 1265, "objectid_1": 1266, "objectid": 1747, "layer_revi": "gambut", "shape_leng": 429079.260415, "globalid": "{2CF8EF08-2914-445D-B58A-34B3EADCEA47}", "shape_Le_1": 427203.8494205073, "shape_Area": 2683153680.2708316, "cluster_id": 0}, "geometry": {"type": "Point", "coordinates": [104.02, -1.56]}}]}]}
</file>

<file path="test_fully_offline.py">
import json
from google.cloud.aiplatform.prediction import LocalModel
from predictor import WildfireHeuristicPredictor

print("--- Starting Final Offline Container Test ---")

# This builds the container with your latest, correct code.
print("Building the CPR container...")
local_model = LocalModel.build_cpr_model(
    ".",
    "asia-southeast2-docker.pkg.dev/haryo-kebakaran/wildfire-detector-repo/wildfire-heuristic-predictor:local-test",
    predictor=WildfireHeuristicPredictor,
    requirements_path="requirements.txt"
)

print("\n--- Deploying container to local Docker endpoint... ---")

with local_model.deploy_to_local_endpoint(host_port=8080) as local_endpoint:
    print("Endpoint is live. Sending prediction request...")

    try:
        # Prepare the request body in the correct format
        with open("incidents.jsonl", "r") as f:
            incident_data = json.load(f)
        request_body = {"instances": [incident_data]}
        temp_request_file = "temp_request.json"
        with open(temp_request_file, "w") as f:
            json.dump(request_body, f)

        # Send the request
        predict_response = local_endpoint.predict(
            request_file=temp_request_file,
            headers={"Content-Type": "application/json"},
        )
        
        if predict_response.status_code == 200:
            print("\n--- ✅ Prediction Successful (Status Code 200) ---")
            print("\n--- Parsed Predictions ---")
            
            # --- THIS IS THE CORRECT PARSING LOGIC ---
            response_content = predict_response.content.decode('utf-8')
            # 1. Parse the entire response as a JSON object (a dictionary)
            response_dict = json.loads(response_content)
            # 2. Extract the list of predictions from the 'predictions' key
            all_predictions = response_dict['predictions']
            # --- END OF CORRECTION ---
            
            for prediction in all_predictions:
                instance_id = prediction['instance_id']
                score = prediction['confidence_score']
                print(f"  Cluster ID: {instance_id}, Predicted Risk Score: {score:.4f}")
        else:
            print(f"\n--- ❌ Prediction Failed with Status Code: {predict_response.status_code} ---")
            print("--- Server Response ---")
            print(predict_response.text)

    except Exception as e:
        print(f"\n--- ❌ Test Script Crashed ---")
        print(f"Error: {e}")

print("\n--- Local endpoint has been shut down. Test complete. ---")
</file>

<file path="test_logic_offline.py">
import json
import numpy as np
# Import the core logic class directly
from predictor import FireRiskHeuristicModel 

print("--- Starting Pure Python Offline Logic Test ---")

# 1. Load the model configuration
try:
    with open("config.json", 'r') as f:
        model_config = json.load(f)
    print("Successfully loaded config.json")
except Exception as e:
    print(f"Failed to load config.json: {e}")
    exit()

# 2. Instantiate the core logic model
risk_model = FireRiskHeuristicModel(config=model_config)
print("Heuristic model instantiated.")

# 3. Open the local incidents file and process it
print("\n--- Processing incidents.jsonl with manual pre-processing ---")
try:
    with open("incidents.jsonl", "r") as f:
        file_content = f.read()
        incident_data = json.loads(file_content)
        
        # --- MANUAL PRE-PROCESSING STEP ---
        # This step simulates what the WildfireHeuristicPredictor.preprocess
        # method does before calling the model.
        hotspots = incident_data.get("hotspots", [])
        if hotspots:
            frp_values = [h['properties']['frp_mean'] for h in hotspots if 'frp_mean' in h.get('properties', {})]
            avg_frp = np.mean(frp_values) if frp_values else 0
        else:
            avg_frp = 0
        
        # Add the new value to the data dictionary before scoring
        incident_data['avg_frp'] = avg_frp
        print(f"Pre-processing complete. Calculated Average FRP: {avg_frp:.2f}")
        # --- END OF MANUAL PRE-PROCESSING ---

        cluster_id = incident_data.get("cluster_id", "N/A")
        
        # Pass the pre-processed data to the model
        result = risk_model.predict_confidence(incident_data)
        score = result['confidence_score']
        
        print(f"\n  Cluster ID: {cluster_id}, Predicted Risk Score: {score:.4f}")

except Exception as e:
    print(f"\nAn error occurred: {e}")

print("\n--- Test complete. ---")
</file>

<file path="test_with_gcs.py">
import os
import json
from datetime import datetime
from google.cloud import aiplatform, storage

# --- Configuration (remains the same) ---
PROJECT_ID = "haryo-kebakaran"
REGION = "asia-southeast2"
GCS_BUCKET_NAME = "fire-app-bucket"
MODEL_RESOURCE_NAME = "projects/216616339006/locations/asia-southeast2/models/4863210298397425664" 
GCS_INPUT_URI = "gs://fire-app-bucket/01_incidents_detected/2019-09-21/incidents.jsonl"


def main():
    """Runs a full end-to-end test against the deployed Vertex AI model using a real GCS file."""

    aiplatform.init(project=PROJECT_ID, location=REGION)
    storage_client = storage.Client()
    
    print(f"--- 1. Verifying input file exists ---")
    bucket_name, blob_name = GCS_INPUT_URI.replace("gs://", "").split("/", 1)
    bucket = storage_client.bucket(bucket_name)
    input_blob = bucket.blob(blob_name)
    
    if not input_blob.exists():
        print(f"ERROR: The specified input file does not exist: {GCS_INPUT_URI}")
        return
    print(f"Input file verified: {GCS_INPUT_URI}")

    print("\n--- 2. Triggering Vertex AI Batch Prediction Job ---")
    
    model = aiplatform.Model(MODEL_RESOURCE_NAME)
    
    timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
    job_display_name = f"real_data_test_job_{timestamp}"
    gcs_output_uri_prefix = f"gs://{GCS_BUCKET_NAME}/gcs_testing_output/{job_display_name}/"

    # --- THE FIX IS HERE ---
    # We must specify the machine type for custom models.
    job = model.batch_predict(
        job_display_name=job_display_name,
        gcs_source=GCS_INPUT_URI,
        gcs_destination_prefix=gcs_output_uri_prefix,
        sync=True,
        machine_type="n1-standard-2",  # Added this required parameter
    )
    # -----------------------
    
    print(f"Batch prediction job '{job.display_name}' completed.")
    print(f"Job state: {job.state}")

    print("\n--- 3. Downloading and verifying results ---")
    
    output_location = job.output_info.gcs_output_directory
    print(f"Results are located in: {output_location}")

    prefix = output_location.replace(f"gs://{GCS_BUCKET_NAME}/", "")
    blobs = storage_client.list_blobs(GCS_BUCKET_NAME, prefix=prefix)
    result_blob = next((b for b in blobs if "prediction.results" in b.name), None)

    if not result_blob:
        print("ERROR: Could not find prediction results file in the output directory.")
        return

    result_content = result_blob.download_as_string().decode('utf-8')

    print("\n--- Parsed Predictions ---")
    for line in result_content.strip().split('\n'):
        prediction = json.loads(line)
        instance_id = prediction['instance_id']
        score = prediction['confidence_score']
        print(f"  Cluster ID: {instance_id}, Predicted Risk Score: {score:.4f}")

    print("\n--- Test complete. ---")

if __name__ == "__main__":
    main()
</file>

</files>
